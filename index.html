<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner Comparator Game</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a1a1a;
            color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 500px;
        }
        h1 {
            text-align: center;
            color: #ff4d4d;
            font-size: 1.8em;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #ccc;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #3a3a3a;
            color: #f5f5f5;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            margin-bottom: 20px;
        }
        button:hover {
            background-color: #e63a3a;
        }
        #output {
            background-color: #3a3a3a;
            padding: 15px;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.4;
        }
        #output h3 {
            color: #ff4d4d;
            margin-top: 0;
        }
        .rank-item {
            padding: 5px 0;
            border-bottom: 1px solid #555;
        }
        .rank-item.yours {
            background-color: #ff4d4d;
            color: #1a1a1a;
            border-radius: 3px;
            padding: 8px;
            margin: 5px 0;
        }
        .error {
            color: #ff6b6b;
            text-align: center;
        }
        .svg-btn {
            margin-left: 8px;
            padding: 3px 8px;
            background: #444;
            color: #fff;
            border: none;
            border-radius: 3px;
            font-size: 0.8em;
            cursor: pointer;
        }
        .svg-btn:hover {
            background: #ff4d4d;
        }
        .svg-modal-bg {
            position: fixed;
            left: 0; top: 0; right: 0; bottom: 0;
            background: rgba(32,32,32,0.85);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .svg-modal {
            background: #2a2a2a;
            padding: 24px 18px 16px 18px;
            border-radius: 10px;
            box-shadow: 0 6px 32px #0008;
            text-align: center;
            max-width: 400px;
        }
        .svg-modal-title {
            color: #ff4d4d;
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        .svg-modal-close {
            background: #ff4d4d;
            color: #fff;
            border: none;
            border-radius: 3px;
            padding: 6px 16px;
            margin-top: 8px;
            font-size: 1em;
            cursor: pointer;
        }
        .svg-modal-close:hover {
            background: #e63a3a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Partner Comparator Game</h1>
        <form id="inputForm">
            <label for="name">Woman's First Name:</label>
            <input type="text" id="name" required>

            <label for="age">Her Age:</label>
            <input type="number" id="age" min="18" max="100" required>

            <label for="height">Her Height (inches):</label>
            <input type="number" id="height" min="56" max="78" required>

            <label for="partners">Reported Partners:</label>
            <input type="number" id="partners" min="1" max="50" required>

            <label for="length">Your Length (inches):</label>
            <input type="number" id="length" step="0.1" min="0" required>

            <label for="girth">Your Girth (inches):</label>
            <input type="number" id="girth" step="0.1" min="0" required>

            <button type="submit">Compare</button>
        </form>
        <div id="output"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('inputForm');

            // Updated stats (blended from Veale 2015, Herbenick 2014, Wessells 1996)
            const MU_LENGTH = 5.3; // inches
            const SD_LENGTH = 0.7;
            const MU_GIRTH = 4.7;
            const SD_GIRTH = 0.5;
            const RHO = 0.25; // correlation length-girth
            const USE_LOGNORMAL = false; // toggle log-normal vs normal

            // Log-normal params (if used)
            const MU_LOG_LENGTH = Math.log(MU_LENGTH) - 0.5 * Math.log(1 + (SD_LENGTH / MU_LENGTH) ** 2);
            const SD_LOG_LENGTH = Math.sqrt(Math.log(1 + (SD_LENGTH / MU_LENGTH) ** 2));
            const MU_LOG_GIRTH = Math.log(MU_GIRTH) - 0.5 * Math.log(1 + (SD_GIRTH / MU_GIRTH) ** 2);
            const SD_LOG_GIRTH = Math.sqrt(Math.log(1 + (SD_GIRTH / MU_GIRTH) ** 2));

            // Gaussian CDF (approx with error function)
            function normCDF(x, mu = 0, sd = 1) {
                return 0.5 * (1 + erf((x - mu) / (sd * Math.sqrt(2))));
            }

            // Error function approximation
            function erf(x) {
                const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
                const a4 = -1.453152027, a5 = 1.061405429, t = 1 / (1 + 0.3275911 * Math.abs(x));
                const sign = x >= 0 ? 1 : -1;
                const poly = t * Math.exp(-x * x - 1.061405429 * t * t);
                return sign * (1 - poly * (a1 * t + a2 * t * t + a3 * t * t * t + a4 * t * t * t * t + a5 * t * t * t * t * t));
            }

            // Inverse CDF (bisection search)
            function normInvCDF(p) {
                if (p <= 0) return -6;
                if (p >= 1) return 6;
                let low = -6, high = 6;
                for (let i = 0; i < 50; i++) {
                    let mid = (low + high) / 2;
                    if (normCDF(mid) < p) low = mid;
                    else high = mid;
                }
                return (low + high) / 2;
            }

            // Generate correlated uniforms via bivariate normal
            function generateCopula(n, rho) {
                const Z1 = [];
                const Z2 = [];
                for (let i = 0; i < n; i++) {
                    let u1 = Math.random(), u2 = Math.random();
                    let Z1i = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                    Z1.push(Z1i);
                    let sqrtTerm = Math.sqrt(1 - rho * rho);
                    u1 = Math.random(); u2 = Math.random();
                    let indep = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                    Z2.push(rho * Z1i + sqrtTerm * indep);
                }
                return [Z1, Z2];
            }

            // Mixture model for sampling length and girth, allows rare extreme outliers
            function sampleOne() {
                // Probability that a sample will be an outlier (e.g., 1.5%)
                const OUTLIER_CHANCE = 0.015;

                if (Math.random() < OUTLIER_CHANCE) {
                    // Outlier: sample from an extreme upper percentile (e.g., 99.9th to 100th)
                    const extremePercentile = 0.999 + 0.001 * Math.random();
                    let extremeLength, extremeGirth;
                    if (USE_LOGNORMAL) {
                        extremeLength = Math.exp(MU_LOG_LENGTH + SD_LOG_LENGTH * normInvCDF(extremePercentile));
                        extremeGirth = Math.exp(MU_LOG_GIRTH + SD_LOG_GIRTH * normInvCDF(extremePercentile));
                    } else {
                        extremeLength = MU_LENGTH + SD_LENGTH * normInvCDF(extremePercentile);
                        extremeGirth = MU_GIRTH + SD_GIRTH * normInvCDF(extremePercentile);
                    }
                    extremeLength = Math.max(8, Math.min(11, extremeLength));
                    extremeGirth = Math.max(6, Math.min(8, extremeGirth));
                    return { length: extremeLength, girth: extremeGirth };
                } else {
                    const [Zs1, Zs2] = generateCopula(1, RHO);
                    const uL = normCDF(Zs1[0]);
                    const uG = normCDF(Zs2[0]);
                    let L, G;
                    if (USE_LOGNORMAL) {
                        L = Math.exp(MU_LOG_LENGTH + SD_LOG_LENGTH * normInvCDF(uL));
                        G = Math.exp(MU_LOG_GIRTH + SD_LOG_GIRTH * normInvCDF(uG));
                    } else {
                        L = MU_LENGTH + SD_LENGTH * normInvCDF(uL);
                        G = MU_GIRTH + SD_GIRTH * normInvCDF(uG);
                    }
                    return {
                        length: Math.max(2, Math.min(9, L)),
                        girth: Math.max(2.5, Math.min(6.5, G))
                    };
                }
            }

            // Volume: corrected based on GitHub help
            function computeVolume(length, girth) {
                const r = girth / (2 * Math.PI);
                return Math.PI * r * r * length;
            }

            // Adjust partners (GSS-based, median ~7-12 at 40)
            function adjustPartners(reported, age) {
                const base = Math.min(4.5, Math.log(Math.max(1, age - 17)));
                const avg = Math.round(2 + base * 3);
                const adj = Math.max(1, Math.min(50, Math.round(reported * 0.8 + avg * 0.2)));
                return adj;
            }

            // Percentile for single dimension
            function getPercentile(value, mu, sd, isLogNormal = false) {
                if (isLogNormal) {
                    const logVal = Math.log(value);
                    const logMu = Math.log(mu) - 0.5 * Math.log(1 + (sd / mu) ** 2);
                    const logSd = Math.sqrt(Math.log(1 + (sd / mu) ** 2));
                    return Math.round(100 * normCDF(logVal, logMu, logSd));
                }
                return Math.round(100 * normCDF(value, mu, sd));
            }

            // Statistically model hand dimensions based on height (inches)
            function sampleHandDimensions(heightInches) {
                // Regression-based means
                const meanLength = 0.107 * heightInches; // hand length in inches
                const meanBreadth = 0.045 * heightInches; // palm breadth in inches
                // Add normal random variation
                const length = meanLength + (Math.random() - 0.5) * 0.6; // SD ~0.3"
                const breadth = meanBreadth + (Math.random() - 0.5) * 0.4; // SD ~0.2"
                return {
                    length: Math.max(5.5, Math.min(8, length)),
                    breadth: Math.max(2.3, Math.min(3.8, breadth))
                };
            }
            
            // [FINAL, CORRECTED DESIGN] Hand behind cylinder
            function generateCylinderHandSVG(length, girth, handLength, handBreadth) {
                const barDia = girth / Math.PI;
                const svgW = 350,
                    svgH = 250;
                const fleshTone = '#E2B698';

                // --- Hand SVG Template Data from user ---
                // [FIX] Removed the internal `transform` from this group (we will control transform externally)
                const handPathData = `
                    <g fill="${fleshTone}">
                        <path d="M590.554,52.88 c-0.496,5.034-0.822,10.029-0.196,15.363c0.613,5.321-1.878,6.495-4.46,8.321c-2.582,1.839-3.873,2.961-4.473,1.961 c0.169-1.761,0.235-3.365,0.235-4.891c0.0[...]"/>
                        <path d="M584.281,66.47 c1.265,1.278-0.483,4.473-2.021,8.164c0.026-5.256-0.639-9.547,0.143-15.376c0.952-7.16,1.709-10.042,3.991-11.255 c-2.465,4.134-2.008,9.155-0.874,10.29C586[...]"/>
                        <path d="M598.431,70.865 c-1.617,0.887-3.912,2.008-5.973,2.739c-3.143,1.135-5.725,1.356-4.317-1.578c1.943-4.056,1.813-2.869,1.187-6.43 c-0.626-3.56,0.156-12.05,0.9-17.293c0.743[...]"/>
                        <path d="M591.949,58.045 c-3.3,8.829,2.882,9.116,0.509,15.559c-3.143,1.135-5.725,1.356-4.317-1.578c1.943-4.056,1.813-2.869,1.187-6.43 c-0.626-3.56,0.156-12.05,0.9-17.293c0.743-[...]"/>
                        <path d="M609.164,64.37 c-0.3,5.165-2.308,7.982-4.617,8.282c-1.93,0.274-4.069-1.239-5.543-4.617c0.626-5.373-1.956-5.582-1.239-13.524 c0.704-7.956-0.104-15.363,1.343-21.61c1.082[...]"/>
                        <path d="M604.547,72.652 c-1.93,0.274-4.069-1.239-5.543-4.617c0.626-5.373-1.956-5.582-1.239-13.524c0.704-7.956-0.104-15.363,1.343-21.61 c1.082-4.682,3.782-5.438,5.517-5.06c-2.6[...]"/>
                        <path d="M637.882,81.39 c-0.17,2.543-1.721,5.256-1.721,5.256s1.187,8.047-3.313,17.541c-4.121,6.612-15.976,17.202-15.976,17.202s0.091,0.965,0.287,2.595 c0.574,4.891,2.139,15.767[...]"/>
                        <path d="M637.882,81.39 c-0.17,2.543-1.721,5.256-1.721,5.256s1.187,8.047-3.313,17.541c-4.121,6.612-15.976,17.202-15.976,17.202s0.091,0.965,0.287,2.595 c-3.286,2.034-9.573,5.517[...]"/>
                        <path d="M615.111,72.443 c-2.074-3.704-7.199-5.451-7.199-5.451c-1.865-5.66-0.952-12.52-1.656-15.441C604,40.269,604,31.114,609.086,31.283h0.013 c-3.547,3.873-3.052,11.242-1.721,[...]"/>
                    </g>
                `;
                
                // Original path bounding box/min coords measured from the original SVG source:
                const pathMinX = 579;
                // NOTE: We adjust pathMinY and handNaturalH so that we effectively crop off
                // the lower portion (wrist) of the original hand drawing. By increasing pathMinY
                // we start the drawn region lower in the source path, and by reducing handNaturalH
                // we stop before the wrist region. Tweak these two numbers until wrist is excluded.
                // (These were 31 and 122; we've moved the source top down and reduced height.)
                const pathMinY = 50;      // increased to crop the wrist at the bottom
                const handNaturalW = 62;
                const handNaturalH = 92;  // reduced from 122 to exclude wrist from the "hand" height
                
                // --- Scaling and Positioning ---
                const padding = 20;
                // we base scaling on whichever visual element is taller (hand vs cylinder length)
                const maxH = Math.max(handLength, length);
                const scale = (svgH - padding * 2) / maxH;

                // desired drawn size in screen px
                const handDrawH = handLength * scale;
                const handDrawW = (handNaturalW / handNaturalH) * handDrawH;
                const handScaleFactor = handDrawH / handNaturalH;

                const cylH = length * scale;
                const cylW = barDia * scale;
                const cylR = cylW / 2;

                const centerX = svgW / 2;
                const bottomY = svgH - padding;

                // Position the (unrotated) hand so it sits with bottom at bottomY
                const handX = centerX - (handDrawW / 2);
                const handY = bottomY - handDrawH;

                // For rotation we will rotate about the center of the hand bounding box (in SVG coords)
                const handBBoxCenterX = handX + handDrawW / 2;
                const handBBoxCenterY = handY + handDrawH / 2;

                const cylX = centerX - cylR;
                const shaftH = Math.max(0, cylH - cylR);
                const shaftY = bottomY - cylH + (cylR > cylH ? 0 : cylR);
                const domeCY = shaftY;

                // --- Overlap Calculation ---
                const fingerReach = handBreadth * 1.1;
                const thumbReach = handLength * 0.35;
                const overlap = (fingerReach + thumbReach) - girth;

                // Build an inner transform to translate the original hand path to origin and scale it.
                // We'll then rotate the whole inner-group about the hand bounding-box center.
                const innerTransform = `translate(${handX}, ${handY}) scale(${handScaleFactor}) translate(-${pathMinX}, -${pathMinY})`;
                const rotatedWrapperTransform = `rotate(90 ${handBBoxCenterX} ${handBBoxCenterY})`;

                // Put the hand path inside a wrapper <g> that we rotate by 90deg clockwise about its center.
                const handGroup = `<g transform="${innerTransform}">${handPathData}</g>`;
                const rotatedHandGroup = `<g transform="${rotatedWrapperTransform}">${handGroup}</g>`;

                return `
<svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <radialGradient id="cylShine" cx="60%" cy="35%" r="70%">
            <stop offset="0%" stop-color="#c7d2ff" stop-opacity="0.85"/>
            <stop offset="65%" stop-color="#7e9ae6" stop-opacity="0.8"/>
            <stop offset="100%" stop-color="#465cb4" stop-opacity="1"/>
        </radialGradient>
    </defs>
    
    <!-- Hand (rotated 90° clockwise and with wrist cropped via adjusted source bbox) -->
    ${rotatedHandGroup}

    <!-- Cylinder -->
    <g>
      <rect x="${cylX}" y="${shaftY}" width="${cylW}" height="${shaftH}" fill="url(#cylShine)" />
      <path d="M ${cylX} ${domeCY} A ${cylR} ${cylR} 0 0 1 ${cylX + cylW} ${domeCY}" fill="url(#cylShine)" />
    </g>

    <!-- Overlap Text -->
    <text x="${svgW / 2}" y="${svgH - 5}" fill="${overlap > 0 ? 'lightgreen' : '#ff9a9a'}" font-size="12" text-anchor="middle" font-weight="bold">
        ${overlap > 0 ? `Overlap: ${overlap.toFixed(1)}"` : `Gap: ${Math.abs(overlap).toFixed(1)}"`}
    </text>
</svg>
                `;
            }


            // Modal for SVG display
            function showSVGModal(svg, title) {
                let modalBg = document.createElement('div');
                modalBg.className = "svg-modal-bg";
                let modal = document.createElement('div');
                modal.className = "svg-modal";
                modal.innerHTML = `<div class="svg-modal-title">${title}</div>
                    <div>${svg}</div>
                    <button class="svg-modal-close">Close</button>`;
                modalBg.appendChild(modal);
                document.body.appendChild(modalBg);
                modal.querySelector('.svg-modal-close').onclick = function() {
                    document.body.removeChild(modalBg);
                };
                modalBg.onclick = function(e) {
                    if (e.target === modalBg) document.body.removeChild(modalBg);
                };
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                try {
                    const name = document.getElementById('name').value.trim();
                    const age = parseInt(document.getElementById('age').value);
                    const height = parseFloat(document.getElementById('height').value);
                    let partners = parseInt(document.getElementById('partners').value);
                    const yourLength = parseFloat(document.getElementById('length').value);
                    const yourGirth = parseFloat(document.getElementById('girth').value);

                    if (!name || isNaN(age) || isNaN(partners) || isNaN(height) ||
                        isNaN(yourLength) || isNaN(yourGirth) ||
                        yourLength <= 0 || yourGirth <= 0 ||
                        height < 56 || height > 78) {
                        document.getElementById('output').innerHTML = '<p class="error">Fill in all fields with valid numbers, champ.</p>';
                        return;
                    }

                    partners = adjustPartners(partners, age);
                    const yourVolume = computeVolume(yourLength, yourGirth);
                    const lengthPercentile = getPercentile(yourLength, MU_LENGTH, SD_LENGTH, USE_LOGNORMAL);
                    const girthPercentile = getPercentile(yourGirth, MU_GIRTH, SD_GIRTH, USE_LOGNORMAL);

                    // Generate hand stats
                    const handStats = sampleHandDimensions(height);

                    // Generate partners
                    const allVolumes = [yourVolume];
                    const allData = [{ length: yourLength, girth: yourGirth, vol: yourVolume, isYours: true, name: 'You' }];
                    for (let i = 0; i < partners; i++) {
                        const { length, girth } = sampleOne();
                        const vol = computeVolume(length, girth);
                        allVolumes.push(vol);
                        allData.push({ length, girth, vol, isYours: false, name: `Partner ${i+1}` });
                    }

                    // Sort by volume desc
                    const sorted = allData.map((d, idx) => ({ ...d, rank: idx + 1 })).sort((a, b) => b.vol - a.vol);
                    const yourRank = sorted.findIndex(d => d.isYours) + 1;
                    const volumePercentile = Math.round(100 * (1 - yourRank / (partners + 1)));

                    let output = `<h3>${name}, ${age} years young, here's the raw deal:</h3>`;
                    output += `<p><em>Adjusted partners: ${partners} (tweaked for her age). Your stats: ${yourLength}"L x ${yourGirth}"G. Length percentile: ${lengthPercentile}%, Girth: ${girthPercentile}%.</em></p>`;
                    output += `<p>${volumePercentile >= 80 ? 'You’re packing serious heat—top shelf.' : volumePercentile >= 60 ? 'You’re outgunning most—girth’s doing work.' : volumePercentile >= 40 ? 'You’re about average—nothing to sneeze at.' : 'You’re on the smaller side—don’t panic.'}</p>`;
                    output += `<p><strong>Full ranking (by volume):</strong></p>`;
                    sorted.forEach((d, i) => {
                        const className = d.isYours ? 'yours' : '';
                        // SVG button for this partner
                        const svgBtn = `<button type="button" class="svg-btn" data-idx="${i}">SVG</button>`;
                        const fmt = d.isYours
                            ? `<strong>${d.name}</strong>: ${d.length.toFixed(1)}"L x ${d.girth.toFixed(1)}"G (${d.vol.toFixed(0)} vol) ${svgBtn}`
                            : `${d.name}: ${d.length.toFixed(1)}"L x ${d.girth.toFixed(1)}"G (${d.vol.toFixed(0)} vol) ${svgBtn}`;
                        output += `<div class="${className} rank-item" data-idx="${i}">${fmt}</div>`;
                    });
                    output += `<p><small>Data’s legit—blended from top studies. Girth matters more than length, and you’re no slouch there. Keep rocking it.</small></p>`;

                    document.getElementById('output').innerHTML = output;

                    // Add SVG button handlers
                    setTimeout(function() {
                        const svgBtns = document.querySelectorAll('.svg-btn');
                        svgBtns.forEach(btn => {
                            btn.onclick = function(event) {
                                const idx = parseInt(event.target.getAttribute('data-idx'));
                                const d = sorted[idx];
                                const svg = generateCylinderHandSVG(d.length, d.girth, handStats.length, handStats.breadth);
                                const title = `${d.isYours ? "You" : d.name}: ${d.length.toFixed(1)}" × ${d.girth.toFixed(1)}" inside her hand (${handStats.length.toFixed(1)}" × ${handStats.breadth.toFixed(1)}")`;
                                showSVGModal(svg, title);
                            };
                        });
                    }, 0);

                } catch (error) {
                    console.error('Error in form submission:', error);
                    document.getElementById('output').innerHTML = '<p class="error">Something broke—check the console for details.</p>';
                }
            });
        });
    </script>
</body>
</html>
```
