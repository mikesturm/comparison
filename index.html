<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner Comparator Game</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a1a1a;
            color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 500px;
        }
        h1 {
            text-align: center;
            color: #ff4d4d;
            font-size: 1.8em;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #ccc;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #3a3a3a;
            color: #f5f5f5;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            margin-bottom: 20px;
        }
        button:hover {
            background-color: #e63a3a;
        }
        #output {
            background-color: #3a3a3a;
            padding: 15px;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.4;
        }
        #output h3 {
            color: #ff4d4d;
            margin-top: 0;
        }
        .rank-item {
            padding: 5px 0;
            border-bottom: 1px solid #555;
        }
        .rank-item.yours {
            background-color: #ff4d4d;
            color: #1a1a1a;
            border-radius: 3px;
            padding: 8px;
            margin: 5px 0;
        }
        .error {
            color: #ff6b6b;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Partner Comparator Game</h1>
        <form id="inputForm">
            <label for="name">Woman's First Name:</label>
            <input type="text" id="name" required>

            <label for="age">Her Age:</label>
            <input type="number" id="age" min="18" max="100" required>

            <label for="partners">Reported Partners:</label>
            <input type="number" id="partners" min="1" max="50" required>

            <label for="length">Your Length (inches):</label>
            <input type="number" id="length" step="0.1" min="0" required>

            <label for="girth">Your Girth (inches):</label>
            <input type="number" id="girth" step="0.1" min="0" required>

            <button type="submit">Compare</button>
        </form>
        <div id="output"></div>
    </div>

    <script>
        console.log('Script loaded'); // Debug: confirm script runs
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('inputForm');
            if (!form) {
                console.error('Form not found');
                return;
            }

            // Updated stats (blended from Veale 2015, Herbenick 2014, Wessells 1996)
            const MU_LENGTH = 5.3; // inches
            const SD_LENGTH = 0.7;
            const MU_GIRTH = 4.7;
            const SD_GIRTH = 0.5;
            const RHO = 0.25; // correlation length-girth
            const USE_LOGNORMAL = false; // toggle log-normal vs normal

            // Log-normal params (if used)
            const MU_LOG_LENGTH = Math.log(MU_LENGTH) - 0.5 * Math.log(1 + (SD_LENGTH / MU_LENGTH) ** 2);
            const SD_LOG_LENGTH = Math.sqrt(Math.log(1 + (SD_LENGTH / MU_LENGTH) ** 2));
            const MU_LOG_GIRTH = Math.log(MU_GIRTH) - 0.5 * Math.log(1 + (SD_GIRTH / MU_GIRTH) ** 2);
            const SD_LOG_GIRTH = Math.sqrt(Math.log(1 + (SD_GIRTH / MU_GIRTH) ** 2));

            // Gaussian CDF (approx with error function)
            function normCDF(x, mu = 0, sd = 1) {
                return 0.5 * (1 + erf((x - mu) / (sd * Math.sqrt(2))));
            }

            // Error function approximation
            function erf(x) {
                const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
                const a4 = -1.453152027, a5 = 1.061405429, t = 1 / (1 + 0.3275911 * Math.abs(x));
                const sign = x >= 0 ? 1 : -1;
                const poly = t * Math.exp(-x * x - 1.061405429 * t * t);
                return sign * (1 - poly * (a1 * t + a2 * t * t + a3 * t * t * t + a4 * t * t * t * t + a5 * t * t * t * t * t));
            }

            // Inverse CDF (bisection search)
            function normInvCDF(p) {
                if (p <= 0) return -6;
                if (p >= 1) return 6;
                let low = -6, high = 6;
                for (let i = 0; i < 50; i++) {
                    let mid = (low + high) / 2;
                    if (normCDF(mid) < p) low = mid;
                    else high = mid;
                }
                return (low + high) / 2;
            }

            // Generate correlated uniforms via bivariate normal
            function generateCopula(n, rho) {
                const Z1 = [];
                const Z2 = [];
                for (let i = 0; i < n; i++) {
                    let u1 = Math.random(), u2 = Math.random();
                    let Z1i = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                    Z1.push(Z1i);
                    let sqrtTerm = Math.sqrt(1 - rho * rho);
                    u1 = Math.random(); u2 = Math.random();
                    let indep = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                    Z2.push(rho * Z1i + sqrtTerm * indep);
                }
                return [Z1, Z2];
            }

            // Sample one (L, G) pair
            function sampleOne() {
                const [Zs1, Zs2] = generateCopula(1, RHO);
                const uL = normCDF(Zs1[0]);
                const uG = normCDF(Zs2[0]);
                let L, G;
                if (USE_LOGNORMAL) {
                    // Log-normal sampling
                    L = Math.exp(MU_LOG_LENGTH + SD_LOG_LENGTH * normInvCDF(uL));
                    G = Math.exp(MU_LOG_GIRTH + SD_LOG_GIRTH * normInvCDF(uG));
                } else {
                    // Normal sampling
                    L = MU_LENGTH + SD_LENGTH * normInvCDF(uL);
                    G = MU_GIRTH + SD_GIRTH * normInvCDF(uG);
                }
                return { length: Math.max(2, Math.min(9, L)), girth: Math.max(2.5, Math.min(6.5, G)) };
            }

            // Volume: Ï€ r^2 h
            function computeVolume(length, girth) {
                const r = girth / 2;
                return Math.PI * r * r * length;
            }

            // Adjust partners (GSS-based, median ~7-12 at 40)
            function adjustPartners(reported, age) {
                const base = Math.min(4.5, Math.log(Math.max(1, age - 17))); // caps at ~50
                const avg = Math.round(2 + base * 3); // ~7 at 30, ~10 at 40, ~15 at 50
                const adj = Math.max(1, Math.min(50, Math.round(reported * 0.8 + avg * 0.2)));
                return adj;
            }

            // Percentile for single dimension
            function getPercentile(value, mu, sd, isLogNormal = false) {
                if (isLogNormal) {
                    const logVal = Math.log(value);
                    const logMu = Math.log(mu) - 0.5 * Math.log(1 + (sd / mu) ** 2);
                    const logSd = Math.sqrt(Math.log(1 + (sd / mu) ** 2));
                    return Math.round(100 * normCDF(logVal, logMu, logSd));
                }
                return Math.round(100 * normCDF(value, mu, sd));
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                try {
                    console.log('Form submitted'); // Debug: confirm submit
                    const name = document.getElementById('name').value.trim();
                    const age = parseInt(document.getElementById('age').value);
                    let partners = parseInt(document.getElementById('partners').value);
                    const yourLength = parseFloat(document.getElementById('length').value);
                    const yourGirth = parseFloat(document.getElementById('girth').value);

                    if (!name || isNaN(age) || isNaN(partners) || isNaN(yourLength) || isNaN(yourGirth) || yourLength <= 0 || yourGirth <= 0) {
                        document.getElementById('output').innerHTML = '<p class="error">Fill in all fields with valid numbers, champ.</p>';
                        return;
                    }

                    partners = adjustPartners(partners, age);
                    const yourVolume = computeVolume(yourLength, yourGirth);
                    const lengthPercentile = getPercentile(yourLength, MU_LENGTH, SD_LENGTH, USE_LOGNORMAL);
                    const girthPercentile = getPercentile(yourGirth, MU_GIRTH, SD_GIRTH, USE_LOGNORMAL);

                    // Generate partners
                    const allVolumes = [yourVolume];
                    const allData = [{ length: yourLength, girth: yourGirth, vol: yourVolume, isYours: true, name: 'You' }];
                    for (let i = 0; i < partners; i++) {
                        const { length, girth } = sampleOne();
                        const vol = computeVolume(length, girth);
                        allVolumes.push(vol);
                        allData.push({ length, girth, vol, isYours: false, name: `Partner ${i+1}` });
                    }

                    // Sort by volume desc
                    const sorted = allData.map((d, idx) => ({ ...d, rank: idx + 1 })).sort((a, b) => b.vol - a.vol);
                    const yourRank = sorted.findIndex(d => d.isYours) + 1;
                    const volumePercentile = Math.round(100 * (1 - yourRank / (partners + 1)));

                    let output = `<h3>${name}, ${age} years young, here's the raw deal:</h3>`;
                    output += `<p><em>Adjusted partners: ${partners} (tweaked for her age). Your stats: ${yourLength}"L x ${yourGirth}"G. Length percentile: ${lengthPercentile}%, Girth: ${girthPercentile}%, Volume rank: #${yourRank}/${partners+1} (${volumePercentile}th percentile).</em></p>`;
                    output += `<p>${volumePercentile >= 80 ? 'Youâ€™re packing serious heatâ€”top shelf.' : volumePercentile >= 60 ? 'Youâ€™re outgunning mostâ€”girthâ€™s doing work.' : volumePercentile >= 40 ? 'Solid middle of the pack, no complaints.' : 'Lower end, but itâ€™s how you use it.'} That ${yourGirth} girth? Still a crowd-pleaser.</p>`;
                    output += `<p><strong>Full ranking (by volume):</strong></p>`;
                    sorted.forEach((d, i) => {
                        const className = d.isYours ? 'yours' : '';
                        const fmt = d.isYours ? `<strong>${d.name}</strong>: ${d.length.toFixed(1)}"L x ${d.girth.toFixed(1)}"G (${d.vol.toFixed(0)} vol)` : `${d.name}: ${d.length.toFixed(1)}"L x ${d.girth.toFixed(1)}"G (${d.vol.toFixed(0)} vol)`;
                        output += `<div class="${className} rank-item">${fmt}</div>`;
                    });
                    output += `<p><small>Dataâ€™s legitâ€”blended from top studies. Girth matters more than length, and youâ€™re no slouch there. Keep rocking it.</small></p>`;

                    document.getElementById('output').innerHTML = output;
                } catch (error) {
                    console.error('Error in form submission:', error);
                    document.getElementById('output').innerHTML = '<p class="error">Something brokeâ€”check the console for details.</p>';
                }
            });
        });
    </script>
</body>
</html>
